# 練習 5: 複雜工具與錯誤處理

## 概述
學習如何實作複雜的異步工具和完整的錯誤處理機制。這個練習展示了MCP在處理真實世界應用場景時的能力和最佳實踐。

## 先決條件
- 完成練習 1-4
- 理解 JavaScript 異步程式設計 (async/await)
- 熟悉錯誤處理機制
- 了解文件系統操作基礎

## 學習目標
- [ ] 掌握異步工具的實作方法
- [ ] 學習完整的錯誤處理和分類策略
- [ ] 理解安全性考量（路徑遍歷、輸入驗證）
- [ ] 實作文件操作和網路請求模擬
- [ ] 掌握複雜數據處理技巧

## 技術要點
- **異步工具實作**: 使用 async/await 處理異步操作
- **錯誤分類處理**: 系統性的錯誤處理和分類
- **安全性檢查**: 防止路徑遍歷和惡意輸入
- **資源管理**: 文件系統和網路資源的管理

## 實作要求

### 繼承功能
保留練習 1-4 的所有功能：
- Echo 工具
- 靜態資源（配置、幫助）
- 基本工具（計算、文字轉換、時間戳）
- 動態資源（用戶、文件、時區）

### 新增複雜工具

#### 1. 文件讀取工具 (`file-read`)
- **功能**: 從數據目錄讀取文件
- **參數**: 
  - `filename`: 文件名稱
  - `encoding`: 編碼格式 (utf8, base64)
- **安全性**: 防止路徑遍歷攻擊
- **錯誤處理**: 文件不存在、權限錯誤

#### 2. 文件寫入工具 (`file-write`)
- **功能**: 向數據目錄寫入文件
- **參數**:
  - `filename`: 文件名稱
  - `content`: 文件內容
  - `encoding`: 編碼格式
  - `overwrite`: 是否覆蓋現有文件
- **安全性**: 路徑驗證、覆蓋保護
- **錯誤處理**: 權限錯誤、磁碟空間

#### 3. HTTP 請求模擬工具 (`http-fetch`)
- **功能**: 模擬 HTTP 請求到預設端點
- **參數**:
  - `url`: 請求 URL
  - `method`: HTTP 方法 (GET, POST, PUT, DELETE)
  - `timeout`: 超時時間
- **模擬響應**: 預設的 API 響應數據
- **錯誤處理**: 超時、網路錯誤、HTTP 錯誤狀態

#### 4. 數據處理工具 (`data-process`)
- **功能**: JSON 數據的各種處理操作
- **操作類型**:
  - `parse`: JSON 解析
  - `stringify`: JSON 格式化
  - `filter`: 陣列過濾
  - `map`: 陣列映射
  - `reduce`: 陣列歸約
- **參數化**: 支援操作參數配置
- **錯誤處理**: 資料格式錯誤、操作參數錯誤

## 開始實作

### 步驟 1: 環境設置
```bash
cd exercises/05-complex-tools
npm install  # 如果需要
```

### 步驟 2: 模組導入
首先導入所需的 Node.js 模組：
```typescript
import fs from 'fs/promises';
import path from 'path';
```

### 步驟 3: 數據結構設計
設置模擬數據和配置：
```typescript
// 模擬 HTTP 響應
const mockHttpResponses = {
  'https://api.example.com/users': {
    status: 200,
    data: [/* 用戶數據 */]
  }
  // 更多端點...
};

// 數據目錄設置
const dataDir = path.join(__dirname, 'data');
```

### 步驟 4: 安全性函數
實作安全性檢查函數：
```typescript
function validateFilename(filename: string) {
  if (filename.includes('..') || filename.includes('/') || filename.includes('\\')) {
    throw new Error('Invalid filename: path traversal not allowed');
  }
}
```

### 步驟 5: 異步工具實作
逐個實作每個複雜工具，注意：
- 完整的錯誤處理
- 參數驗證
- 異步操作管理
- 安全性檢查

### 步驟 6: 測試驗證
```bash
npm run build
npm run test:05
```

## 驗收標準
- [ ] 服務器成功啟動並初始化數據目錄
- [ ] 所有繼承的功能正常工作
- [ ] 文件讀取工具正確讀取文件並顯示元數據
- [ ] 文件寫入工具正確寫入文件並處理覆蓋邏輯
- [ ] HTTP 工具正確模擬請求和響應
- [ ] 數據處理工具支援所有操作類型
- [ ] 所有工具都有適當的錯誤處理
- [ ] 安全性檢查防止惡意操作

## 常見問題

### Q: 如何防止路徑遍歷攻擊？
A: 檢查文件名是否包含 `..`、`/` 或 `\` 字符，並限制操作在指定目錄內。

### Q: 異步工具如何處理超時？
A: 使用 `Promise.race()` 結合 `setTimeout` 實作超時機制。

### Q: 如何設計用戶友好的錯誤信息？
A: 提供清晰的錯誤分類和上下文信息，避免暴露敏感的系統細節。

### Q: 如何測試異步工具？
A: 使用 MCP Inspector 進行互動式測試，並編寫完整的自動化測試用例。

## 錯誤處理指南

### 錯誤分類
1. **輸入驗證錯誤**: 參數格式、類型錯誤
2. **文件系統錯誤**: 文件不存在、權限問題
3. **網路錯誤**: 連接超時、HTTP 錯誤
4. **數據處理錯誤**: JSON 解析、操作失敗
5. **安全性錯誤**: 權限檢查、惡意輸入

### 錯誤處理策略
- 使用 try-catch 包裝所有異步操作
- 提供有意義的錯誤信息
- 記錄錯誤以便調試
- 適當的錯誤恢復機制

## 性能考量

### 文件操作優化
- 使用流式讀寫處理大文件
- 實作適當的快取機制
- 控制併發文件操作數量

### 記憶體管理
- 及時釋放不需要的資源
- 避免記憶體洩漏
- 監控記憶體使用量

## 延伸學習
- 探索更多的異步模式
- 學習 Node.js 流處理
- 研究更進階的錯誤處理策略
- 了解生產環境的安全性考量

## 參考資料
- [Node.js 文件系統 API](https://nodejs.org/api/fs.html)
- [異步程式設計最佳實踐](../../../docs/async-patterns.md)
- [錯誤處理指南](../../../docs/error-handling.md)
- [安全性檢查清單](../../../docs/security-checklist.md)